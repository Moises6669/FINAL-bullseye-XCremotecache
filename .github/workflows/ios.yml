name: ios
on:
  [push,pull_request]

jobs:
  build-and-test:
    runs-on: macos
    steps: 
      - name: Checkout
        uses: actions/checkout@v2.4.0
        with:
           repository: "WW-Digital/ios-community"
           ref: develop
           ssh-key: ${{ secrets.ssh_ww }}

      - name: Install dependencies in Gemfile
        run: bundle install
        
      - name: Common config
        uses: actions/checkout@v2
        with:
          repository: WW-Digital/ios-common-config
          path : /circleci/fetch-keys.sh
      
      - name: Set up ENV variables, and .env file for cocoapods-keys
        run: |
          git clone git@github.com:WW-Digital/ios-common-config.git
          touch .bash_env
          export BASH_ENV="$GITHUB_WORKSPACE/.bash_env"
          bash ./ios-common-config/circleci/fetch-keys.sh WWMobile ./Example
        env:
          TRIGGER_OIDC_CURL_USER: ${{ secrets.TRIGGER_OIDC_CURL_USER }}
          TRIGGER_OIDC_CURL_PASSWORD: ${{ secrets.TRIGGER_OIDC_CURL_PASSWORD }}
          TRIGGER_OIDC_CURL_SERVICE_ACCOUNT: ${{ secrets.TRIGGER_OIDC_CURL_SERVICE_ACCOUNT }}

      - name : Run pod update
        run: |
          source "$GITHUB_WORKSPACE/.bash_env"
          cd Example
          bundle exec pod install
          
      - name: build and test
        run: |
          set +e
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-darwin-amd64 >./cc-test-reporter
          chmod +x ./cc-test-reporter
          ./cc-test-reporter before-build
          bundle exec fastlane test
          TESTS_EXIT_STATUS=$?
          ./cc-test-reporter after-build --exit-code $TESTS_EXIT_STATUS
          exit $TESTS_EXIT_STATUS
        env: 
           CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}

      - name: Danger
        if: always()
        run: |
          source "$GITHUB_WORKSPACE/.bash_env"
          bundle exec danger --verbose

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: "scan"
          path: output/scan/**/*
